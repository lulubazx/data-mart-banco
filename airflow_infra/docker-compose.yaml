version: '3.8'

# --- CONFIGURAÇÃO COMUM ---
x-airflow-common: &airflow-common
  build: .
  environment:
    - AIRFLOW__CORE__EXECUTOR=LocalExecutor
    - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=${AIRFLOW_DB_CONN:?set in .env}
    - AIRFLOW__CORE__LOAD_EXAMPLES=False
    - DBT_PROFILES_DIR=/opt/airflow/dags/bank_dbt
    - AIRFLOW__CORE__FERNET_KEY=${AIRFLOW_FERNET_KEY:?set in .env}
    - AIRFLOW__WEBSERVER__SECRET_KEY=${AIRFLOW_WEBSERVER_SECRET_KEY:?set in .env}
    - AIRFLOW__WEBSERVER__EXPOSE_CONFIG=False
    - AIRFLOW__WEBSERVER__WEB_SERVER_MASTER_TIMEOUT=300
    - AIRFLOW__WEBSERVER__WORKERS=2
    - AIRFLOW__WEBSERVER__WORKER_CLASS=sync
    - GOOGLE_APPLICATION_CREDENTIALS=/opt/airflow/secrets/gcp-sa.json
    - BIGQUERY_PROJECT_ID=${BIGQUERY_PROJECT_ID:?set in .env}
    - BIGQUERY_DATASET_ID=${BIGQUERY_DATASET_ID:-bank_raw}
    - POSTGRES_USER=${POSTGRES_USER:?set in .env}
    - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?set in .env}
    - POSTGRES_DB=${POSTGRES_DB:?set in .env}
    - POSTGRES_HOST=${POSTGRES_HOST:-host.docker.internal}
    - POSTGRES_PORT=${POSTGRES_PORT:-5433}
    - POSTGRES_DRIVER=${POSTGRES_DRIVER:-pg8000}
  volumes:
    - ../:/opt/airflow/dags
    - ../secrets:/opt/airflow/secrets:ro
  depends_on:
    postgres:
      condition: service_healthy

services:
  postgres:
    image: postgres:13
    environment:
      POSTGRES_USER: ${AIRFLOW_DB_USER:?set in .env}
      POSTGRES_PASSWORD: ${AIRFLOW_DB_PASSWORD:?set in .env}
      POSTGRES_DB: ${AIRFLOW_DB_NAME:?set in .env}
    volumes:
      - postgres-db-volume:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "airflow"]
      interval: 5s
      retries: 5

  airflow-init:
    <<: *airflow-common
    command: >
      bash -c "airflow db migrate &&
      airflow users create
      --username ${AIRFLOW_ADMIN_USER:?set in .env}
      --password ${AIRFLOW_ADMIN_PASSWORD:?set in .env}
      --firstname Admin
      --lastname User
      --role Admin
      --email ${AIRFLOW_ADMIN_EMAIL:?set in .env}"

  # --- WEBSERVER (Apenas deleta o PID e inicia) ---
  airflow-webserver:
    <<: *airflow-common
    # Espera 10s, apaga o PID e inicia. Simples e direto.
    command: bash -c "sleep 10 && rm -f /opt/airflow/airflow-webserver.pid && airflow webserver"
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    ports:
      - "8085:8080"

  # --- SCHEDULER (O Cérebro) ---
  airflow-scheduler:
    <<: *airflow-common
    command: bash -c "sleep 10 && airflow scheduler"
    depends_on:
      airflow-init:
        condition: service_completed_successfully

volumes:
  postgres-db-volume:
